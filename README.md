# Flask Project Management API

This repository contains a complete Project Management REST API built with Flask, SQLAlchemy, Marshmallow and Alembic. It exposes CRUD endpoints for users, projects, and tasks, enforces simple role-based access control, and includes pytest-based unit tests and documentation. The latest iteration hardens the application for production-readiness with rate limiting, CORS protection, layered services/repositories, and stronger validation.

## Features

- CRUD endpoints for users, projects, and nested project tasks
- JWT-backed authentication with manager-only write permissions
- Centralised repository layer built on SQLAlchemy sessions, consumed via service classes that encapsulate business logic
- Configurable rate limiting (Flask-Limiter) for login and privileged endpoints
- CORS enforcement (Flask-CORS) with allow-listed origins
- Lightweight HTMX-driven frontend hosted under `frontend/` for browsing, editing, and deleting users and projects
- Hardened password and payload validation with clear JSON error messaging
- SQLite by default with migrations via Flask-Migrate (Alembic)
- Comprehensive pytest suite covering API flows, repositories, and business rules
- Sphinx-style docstrings for automatic API documentation extraction

## Getting Started

### Prerequisites

- Python 3.11+
- A virtual environment is strongly recommended

### Installation

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

Or use the bundled Makefile helpers:

```bash
make venv
source .venv/bin/activate
make install
```

### Configuration

All sensitive defaults are now environment-driven. The application automatically
loads environment variables from a `.env` file in the project root (via
`python-dotenv`) before the Flask app initialises. Copy `.env.example` to
`.env`, adjust the values, and they will take effect on the next run. At a
minimum set the following before running the app in production:

| Variable | Purpose | Default |
|----------|---------|---------|
| `SECRET_KEY` | Flask session signing key | autogenerated (non-production only) |
| `JWT_SECRET_KEY` | JWT signing key | falls back to `SECRET_KEY` |
| `CORS_ALLOWED_ORIGINS` | Comma-separated list of allowed origins | `http://localhost:3000` |
| `LOGIN_RATE_LIMIT` | Limit for `POST /auth/login` | `5 per minute` |
| `SENSITIVE_RATE_LIMIT` | Limit for manager-only routes | `20 per minute` |
| `PAGINATION_DEFAULT_PAGE_SIZE` | List endpoints default page size | `20` |
| `PASSWORD_COMPLEXITY_REGEX` | Regular expression enforced by the user schema | `^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{12,}$` |

Development builds auto-generate an ephemeral `SECRET_KEY` if none is provided,
but when the spawned environment is `production` the loader enforces that you
declare a `SECRET_KEY` (and ideally `JWT_SECRET_KEY`) in the `.env` or system
environment.

### Database Setup

By default the app uses a SQLite database file `project_management.db` in the repository root. 

First, initialize the Alembic migration environment (this creates the migrations/ folder):

```bash
flask --app app:create_app db init
```

Or via Makefile:

```bash
make db-init
```

Then, generate and apply the initial migration to create the database schema:

```bash
flask db migrate -m "initial migration"
flask db upgrade
```

With Makefile equivalents:

```bash
make db-migrate m="initial migration"
make db-upgrade
```

This creates or updates all database tables in sync with your SQLAlchemy models.

If you need to reset or inspect migrations later, use:

```bash
flask db history
flask db downgrade
```

Makefile:

```bash
make db-downgrade
```

### Seeding a Default Admin User

After applying migrations, you can create a default manager user via the CLI:

```bash
flask init-admin
```

Or simply:

```bash
make init-admin
```

If no users exist yet, this command seeds a default manager using the credentials
configured via DEFAULT_ADMIN_EMAIL and DEFAULT_ADMIN_PASSWORD (defaults:
admin@admin.com / admin). Update those environment variables before
running the command if you want to set your own secure values.

You can then call /auth/login with those credentials to obtain a JWT token.

### Running the Server

```bash
flask --app run.py run
```

Or:

```bash
make run
```

The API will be available at `http://127.0.0.1:5000/`.

### Running the Frontend

The repository ships with a static HTMX frontend located in `frontend/`. Serve it with any static file server, for example:

```bash
python -m http.server 3000 --directory frontend
```

Or simply:

```bash
make frontend
```

Override the port or directory as needed, for example `make frontend FRONTEND_PORT=5001`.

By default the frontend expects the API at `http://localhost:5000`. To use a different API origin, set `pm_api_base` in the browser console:

```javascript
localStorage.setItem('pm_api_base', 'http://localhost:8000');
```

Then refresh the page.

## API Usage

Authentication uses short-lived JWTs. Obtain a token via Basic authentication:

```bash
curl -X POST \
  -u manager@example.com:SuperSecret123 \
  http://127.0.0.1:5000/auth/login
```

The response contains an `access_token`. Include it in subsequent requests:

```
Authorization: Bearer <access_token>
Content-Type: application/json
```

All endpoints require a valid bearer token. Any authenticated user can perform
read operations, while only managers can invoke mutating endpoints. Create users
by supplying a `password` field. Passwords must satisfy the configured complexity regex, are stored as hashes, and never
returned by the API.

Key endpoints:

| Resource  | Method & Path             | Description                    |
|-----------|---------------------------|--------------------------------|
| Auth      | `POST /auth/login`        | Exchange Basic credentials for a JWT |
| Users     | `POST /users`             | Create a user (manager only)   |
|           | `GET /users`              | List users                     |
|           | `GET /users/<id>`         | Retrieve a user                |
|           | `PUT /users/<id>`         | Update a user (manager only)   |
|           | `DELETE /users/<id>`      | Delete a user (manager only)   |
| Projects  | `POST /projects`          | Create a project (manager only)|
|           | `GET /projects`           | List projects (paginated)      |
|           | `GET /projects/<id>`      | Retrieve a project             |
|           | `PUT /projects/<id>`      | Update a project (manager only)|
|           | `DELETE /projects/<id>`   | Delete a project (manager only)|
| Tasks     | `POST /projects/<id>/tasks` | Create a task (manager only) |
|           | `GET /projects/<id>/tasks`  | List project tasks (paginated)|
|           | `PUT /projects/<id>/tasks/<task_id>` | Update a task (manager only) |

Projects automatically record the authenticated manager as their creator; any
payload `created_by` value is ignored. Deleting a project removes all of its
tasks thanks to cascading deletes.

Pagination is available on list endpoints via `?page=<n>&per_page=<m>` query parameters. Values beyond configured maxima raise a business validation error, and responses include a `meta` block describing result counts.

Requests that exceed configured rate limits return a `429 rate_limit_exceeded` response. Configure rate windows using the environment variables listed above.

Refer to in-code docstrings under `app/routes/` for detailed parameter and response information.

## Running Tests

```bash
pytest
```

Or:

```bash
make test
```

Coverage run:

```bash
make test-cov
```

The tests use an in-memory SQLite database and cover CRUD happy paths, authorisation failures, and validation edge cases.
Additional integration tests exercise the repository layer and ensure services honour business rules while delegating persistence to repositories.

## Documentation

Endpoints, parameters, and return types are described with Sphinx-style docstrings throughout the modules in `app/routes/`. Full HTML documentation can be generated with Sphinx:

```bash
pip install -r requirements.txt  # if not already installed
sphinx-build -b html docs docs/_build/html
```

Or streamline with:

```bash
make docs
```

Open `docs/_build/html/index.html` in your browser to explore the rendered docs.

Architectural overviews and extension-specific configuration (rate limiting, CORS, repositories) are documented under `docs/`.

## Postman Collection

A Postman collection (`docs/Project Management API.postman_collection.json`) is included for quickly exercising the API endpoints in a collaborative environment.

## Design Rationale

For deeper architectural context, see [`DESIGN_RATIONALE.md`](DESIGN_RATIONALE.md).
