<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Project Manager | Edit Task</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/json-enc.js" defer></script>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="../users/list.html">Project Manager</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="../users/list.html">Users</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../projects/list.html">Projects</a>
            </li>
          </ul>
          <button class="btn btn-outline-secondary btn-sm" id="logout-btn" type="button">
            Logout
          </button>
        </div>
      </div>
    </nav>
    <main class="container py-4" id="task-edit-root">
      <a class="btn btn-link mb-3" id="task-project-link" href="../projects/list.html">&larr; Back to project</a>
      <div id="task-edit-feedback" data-render="form-status"></div>
      <form
        id="task-edit-form"
        class="card card-body shadow-sm mb-3"
        hx-put=""
        hx-ext="json-enc"
        hx-encoding="json"
        hx-target="#task-edit-feedback"
        hx-swap="innerHTML"
      >
        <div class="mb-3">
          <label class="form-label" for="task-title">Title</label>
          <input class="form-control" type="text" id="task-title" name="title" required />
        </div>
        <div class="mb-3">
          <label class="form-label" for="task-status">Status</label>
          <select class="form-select" id="task-status" name="status">
            <option value="todo">To do</option>
            <option value="in_progress">In progress</option>
            <option value="done">Done</option>
            <option value="canceled">Canceled</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label" for="task-due-date">Due date</label>
          <input class="form-control" type="date" id="task-due-date" name="due_date" />
        </div>
        <div class="mb-3">
          <label class="form-label" for="task-assigned-to">Assigned to (user ID)</label>
          <input class="form-control" type="number" id="task-assigned-to" name="assigned_to" min="1" />
        </div>
        <div class="mb-3">
          <label class="form-label" for="task-description">Description</label>
          <textarea class="form-control" id="task-description" name="description" rows="3"></textarea>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <button class="btn btn-primary" type="submit">Save changes</button>
          <button
            class="btn btn-outline-danger"
            type="button"
            id="task-delete-button"
            hx-delete=""
            hx-target="#task-delete-feedback"
            hx-swap="innerHTML"
          >
            Delete task
          </button>
        </div>
      </form>
      <div
        id="task-delete-feedback"
        data-render="form-status"
        class="mb-3"
      ></div>
      <div
        id="task-prefill"
        data-render="task-prefill"
        data-prefill-form="#task-edit-form"
        data-task-id=""
        hx-swap="outerHTML"
      ></div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="../static/auth.js" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const taskId = params.get("id");
        const projectId = params.get("projectId");
        const form = document.getElementById("task-edit-form");
        const feedback = document.getElementById("task-edit-feedback");
        const deleteFeedback = document.getElementById("task-delete-feedback");
        const deleteButton = document.getElementById("task-delete-button");
        const prefill = document.getElementById("task-prefill");
        const projectLink = document.getElementById("task-project-link");

        if (!taskId || !projectId) {
          if (feedback) {
            feedback.innerHTML =
              '<div class="alert alert-warning">Missing task or project id. Open this page from the project view.</div>';
          }
          if (form) {
            form.classList.add("d-none");
          }
          if (deleteButton) {
            deleteButton.classList.add("d-none");
          }
          return;
        }

        if (form) {
          form.setAttribute("hx-put", `/projects/${projectId}/tasks/${taskId}`);
          form.addEventListener("htmx:configRequest", (event) => {
            const params = event.detail && event.detail.parameters;
            if (!params) return;
            sanitizeOptionalTaskFields(params);
          });
        }
        if (deleteButton) {
          deleteButton.setAttribute("hx-delete", `/tasks/${taskId}`);
        }
        if (deleteFeedback) {
          deleteFeedback.dataset.redirect = `../projects/detail.html?id=${encodeURIComponent(projectId)}`;
        }
        if (projectLink) {
          projectLink.href = `../projects/detail.html?id=${encodeURIComponent(projectId)}`;
        }
        if (prefill) {
          prefill.dataset.taskId = taskId;
          prefill.setAttribute("hx-get", `/projects/${projectId}/tasks?page=1&per_page=100`);
          prefill.setAttribute("hx-trigger", "load");
          if (window.htmx) {
            htmx.process(prefill);
          }
        }
      });

      function sanitizeOptionalTaskFields(params) {
        if (typeof params.due_date === "string") {
          const trimmed = params.due_date.trim();
          if (!trimmed || !/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
            params.due_date = null;
          } else {
            params.due_date = trimmed;
          }
        } else if (params.due_date == null) {
          params.due_date = null;
        }

        if (typeof params.assigned_to === "string") {
          const trimmed = params.assigned_to.trim();
          if (!trimmed) {
            params.assigned_to = null;
          } else {
            const parsed = Number(trimmed);
            if (Number.isFinite(parsed)) {
              params.assigned_to = parsed;
            } else {
              params.assigned_to = null;
            }
          }
        } else if (params.assigned_to == null) {
          params.assigned_to = null;
        }
      }
    </script>
  </body>
</html>
